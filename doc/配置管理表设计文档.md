# 配置管理设计文档

## 基本概念

### 应用程序

应用程序故名思意就对应着一个应用。例如Prometheus、Telegraf、Zookeeper等都是一个个的应用程序。

| 字段        | 字段类型 | 含义                         |
| ----------- | -------- | ---------------------------- |
| id          | Long     | 应用程序主键                 |
| name        | String   | 应用程序名称                 |
| alias       | String   | 应用程序别名（界面展示字段） |
| update_time | Date     | 修改时间                     |
| create_time | Date     | 创建时间                     |

### 插件

同一个应用程序存在多个版本。例如Telegraf存在v1.27、v1.26等版本，每个版本就对应一个插件，应用程序与插件是一对多的关系，因为相同应用程序的不同插件可能存在配置文件的差异。

| 字段           | 字段类型 | 含义                                           |
| -------------- | -------- | ---------------------------------------------- |
| id             | Long     | 插件主键                                       |
| name           | String   | 插件名称（格式：应用程序名称-支持的操作-版本） |
| alias          | String   | 插件别名（界面展示字段）                       |
| application_id | Long     | 应用程序主键                                   |
| os             | String   | 适配操作系统                                   |
| version        | String   | 插件版本号                                     |
| description    | String   | 描述（支持markdown）                           |
| update_time    | date     | 修改时间                                       |
| create_time    | date     | 创建时间                                       |

### 配置文件

配置文件也就是插件的具体配置，一个具体的插件可能包含多个配置文件。

| 字段        | 字段类型 | 含义                                                         |
| ----------- | -------- | ------------------------------------------------------------ |
| id          | Long     | 配置文件主键                                                 |
| name        | String   | 配置文件名称                                                 |
| alias       | String   | 配置文件别名（界面展示字段）                                 |
| format      | String   | 配置文件的格式                                               |
| path        | String   | 配置文件的路径（可使用变量）                                 |
| description | String   | 描述                                                         |
| type        | Integer  | 分类标识（可自定义分类标识，用于区分该配置是不是软件必须的配置，没有这份配置软件无法启动；业务配置，可有可无的业务配置等，设计目的是当一个插件存在多个配置文件时，对这几个配置文件进行一定的区分或者分组） |
| update_time | Date     | 修改时间                                                     |
| create_time | Date     | 创建时间                                                     |

### 业务模板

关于一个插件的某一个完整的配置文件可以拆分成一个个的业务模板，例如将Prometheus中的抓取目标配置拆分成`file_sd_config`、具体抓取目标两个业务模板。两个模板分别对应不同的配置文件，他们组成一个业务方案也就是抓取目标的业务方案，向用户暴漏的模板名称，相当于以前版本的插件类型。

| 字段             | 字段类型 | 含义                             |
| ---------------- | -------- | -------------------------------- |
| id               | Long     | 业务主键                         |
| name             | String   | 模板名称（相当于以前的插件类型） |
| alias            | String   | 模板别名(界面展示字段)           |
| content          | String   | 模板内容                         |
| description      | String   | 描述模板描述                     |
| business_plan_id | Long     | 业务方案主键                     |
| config_id        | Long     | 配置文件主键                     |
| update_time      | Date     | 修改时间                         |
| create_time      | Date     | 创建时间                         |

### 模板参数

TODO

### 业务方案

业务方案是多个业务模板的组成，它单单是为了方便管理而存在。

| 字段           | 字段类型 | 含义                         |
| -------------- | -------- | ---------------------------- |
| id             | Long     | 业务方案主键                 |
| name           | String   | 业务方案名称                 |
| alias          | String   | 业务方案别名（界面展示字段） |
| application_id | Long     | 应用程序主键                 |
| plugin_id      | Long     | 插件主键                     |
| update_time    | Date     | 修改时间                     |
| create_time    | Date     | 创建时间                     |

### 业务方案和插件关联表

定义业务方案和插件的关联表。

| 字段             | 字段类型 | 含义                         |
| ---------------- | -------- | ---------------------------- |
| id               | Long     | 业务模板和业务方案的关联主键 |
| business_plan_id | Long     | 业务方案主键                 |
| plugin_id        | Long     | 插件主键                     |
| update_time      | Date     | 修改时间                     |
| create_time      | Date     | 创建时间                     |

### 模板变量

模板变量就是在模板参数中，有些参数的值依赖于业务中的参数等，具体用户在初始化插件时是不知道这个参数的值的，所以采用变量的形式，在业务中再对这个变量进行替换。

所有软件和插件相关的基础信息都可以作为变量值：

- 应用程序名称
- 适用系统
- 版本号
- 唯一标识

主体的所有相关字段都可以作为变量（包括主体唯一标识和自定义参数中json的属性）

| 更多操作字段    | 字段类型 | 含义                                           |
| --------------- | -------- | ---------------------------------------------- |
| id              | Long     | 变量主键                                       |
| name            | String   | 变量名称                                       |
| alias           | String   | 变量别名（展示到界面上的）                     |
| description     | String   | 变量描述                                       |
| optional        | String   | 变量可选项（格式通过具体规则分割）             |
| validation_rule | String   | 变量校验规则（正则表达式）                     |
| type            | Integer  | 变量类型（环境变量、自定义变量、普通模板变量） |
| default         | String   | 变量默认值                                     |
| required        | Boolean  | 是否必填                                       |
| data_type       | String   | 变量的数据类型                                 |
| update_time     | Date     | 修改时间                                       |
| create_time     | Date     | 创建时间                                       |

### 主体

主体其实就是配置文件的目标的概念，配置的生成都是作用域这个主体，它是一个全局唯一的字符串，主体除了唯一标识，另有一个字符串的自定义参数，这个字符串支持json结构，可以传入在配置处理时可能用到的其他参数信息，这个自定义参数在生成配置成功的回调信息中也会携带。

### 通过几个流程理解上述表的设计

#### 案例一：从零开始新增telegraf v1.26

- 新增应用程序telegraf
- 新增插件telegraf v1.26，关联telegraf应用程序
- 然后新增业务方案，同时需要关联对应业务模板（可以从已有的选择也可新增）、模板变量以及模板参数，业务模板同时也需要关联配置文件（可以从已有的选择也可新增）

#### 案例二：从telegraf v1.26的配置拷贝telegraf v1.27的配置

- 选择从telegraf v1.26版本配置进行拷贝
- 页面展示telegraf v1.26版本的业务方案
- 在telegraf v1.26版本基础上删除、新增新的业务方案，新增业务方案时，同时需要关联对应业务模板（可以从已有的选择也可新增）、模板变量以及模板参数，业务模板同时也需要关联配置文件（可以从已有的选择也可新增）
- 点击保存则新增业务方案和插件关联表的数据