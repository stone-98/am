# 配置管理设计文档

## 基本概念

### 应用程序

应用程序故名思意就对应着一个应用。例如Prometheus、Telegraf、Zookeeper等都是一个个的应用程序。

| 字段 | 字段类型 | 含义             |
| ---- | -------- | ---------------- |
|      |          | 应用程序唯一标识 |

### 插件

同一个应用程序存在多个版本。例如Telegraf存在v1.27、v1.26等版本，每个版本就对应一个插件，应用程序与插件是一对多的关系，因为相同应用程序的不同插件可能存在配置文件的差异，所以插件是配置管理的主体。

| 字段 | 字段类型 | 含义                 |
| ---- | -------- | -------------------- |
|      |          | 插件唯一标识         |
|      |          | 应用程序唯一标识     |
|      |          | 适配操作系统         |
|      |          | 插件版本号           |
|      |          | 描述（支持markdown） |

### 配置文件

配置文件也就是插件的具体配置，一个插件可能包含多个配置文件。

| 字段 | 字段类型 | 含义                                                         |
| ---- | -------- | ------------------------------------------------------------ |
|      |          | 配置文件唯一标识                                             |
|      |          | 插件唯一标识                                                 |
|      |          | 配置文件的格式                                               |
|      |          | 配置文件的路径（可使用变量）                                 |
|      |          | 描述                                                         |
|      |          | 分类标识（可自定义分类标识，用于区分该配置是不是软件必须的配置，没有这份配置软件无法启动；业务配置，可有可无的业务配置等，设计目的是当一个插件存在多个配置文件时，对这几个配置文件进行一定的区分或者分组） |

### 业务方案

业务方案是对插件的某一配置文件或多个配置文件进行拆分，拆分成多个配置文件段之后，每一个配置文件段关联一个业务模板，多个业务模板组成一个业务方案。以下举两个例子：

- 在Nginx中，例如要新增一个代理那么涉及同一个配置文件

```conf
upstream my_server {                                                         
    server 10.0.0.2:8080;                                                
    keepalive 2000;
}
server {
    listen       80;                                                         
    server_name  10.0.0.1;                                               
    client_max_body_size 1024M;

    location /my/ {
        proxy_pass http://my_server;
        proxy_set_header Host $host:$server_port;
    }
}
```

业务方案是具体向用户暴漏的概念。

| 字段 | 字段类型 | 含义             |
| ---- | -------- | ---------------- |
|      |          | 业务方案唯一标识 |
|      |          | 业务方案别名     |
|      |          | 应用程序唯一标识 |

### 业务模板

关于一个插件的某一个完整的配置文件可以拆分成一个个的业务模板，例如将Prometheus中的抓取目标配置拆分成`file_sd_config`、具体抓取目标两个业务模板。两个模板分别对应不同的配置文件，他们组成一个业务方案也就是抓取目标的业务方案，向用户暴漏的就是具体的业务方案，例如用户要对Prometheus插件新增一个抓取目标的业务方案。

| 字段 | 字段类型 | 含义             |
| ---- | -------- | ---------------- |
|      |          | 模板唯一标识     |
|      |          | 模板别名         |
|      |          | 模板内容         |
|      |          | 参数列表         |
|      |          | 模板描述         |
|      |          | 业务方案唯一标识 |
|      |          | 配置文件唯一标识 |

### 模板参数

TODO

### 模板变量

模板变量就是在模板参数中，有些参数的值依赖于业务中的参数等，具体用户在初始化插件时是不知道这个参数的值的，所以采用变量的形式，在业务中再对这个变量进行替换。

所有软件和插件相关的基础信息都可以作为变量值：

- 应用程序名称
- 适用系统
- 版本号
- 唯一标识

主体的所有相关字段都可以作为变量（包括主体唯一标识和自定义参数中json的属性）

| 更多操作字段 | 字段类型 | 含义                                           |
| ------------ | -------- | ---------------------------------------------- |
|              |          | 变量唯一标识                                   |
|              |          | 变量别名                                       |
|              |          | 变量描述                                       |
|              |          | 变量可选项                                     |
|              |          | 变量校验规则                                   |
|              |          | 变量类型（环境变量、自定义变量、普通模板变量） |
|              |          | 变量默认值                                     |
|              |          | 是否必填                                       |
|              |          | 变量的数据类型                                 |

### 主体

主体其实就是配置文件的目标的概念，配置的生成都是作用域这个主体，它是一个全局唯一的字符串，主体除了唯一标识，另有一个字符串的自定义参数，这个字符串支持json结构，可以传入在配置处理时可能用到的其他参数信息，这个自定义参数在生成配置成功的回调信息中也会携带。